<!doctype html>
<html lang="de">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Admin – Hot-Dog Kasse</title>
    <style>
        :root{--bg:#f6f8fa;--card:#fff;--muted:#666;--ink:#111;--shadow:0 2px 10px rgba(0,0,0,.08)}
        *{box-sizing:border-box}
        body{font-family:system-ui,Arial,sans-serif;margin:0;background:var(--bg);color:var(--ink)}
        header{padding:14px 16px;background:#111;color:#fff;display:flex;align-items:center;gap:12px}
        header a{color:#fff;text-decoration:none;background:rgba(255,255,255,.12);padding:8px 10px;border-radius:10px}
        .wrap{max-width:1100px;margin:0 auto;padding:16px}
        .tabs{display:flex;gap:8px;flex-wrap:wrap}
        .tab-btn{border:none;background:var(--card);box-shadow:var(--shadow);padding:10px 14px;border-radius:12px;cursor:pointer}
        .tab-btn.active{background:#111;color:#fff}
        .card{background:var(--card);border-radius:16px;box-shadow:var(--shadow);padding:14px;margin-top:14px}
        table{border-collapse:collapse;width:100%}
        th,td{border-bottom:1px solid #eee;padding:10px;text-align:left}
        th{background:#fafafa;font-weight:600}
        input[type="text"],input[type="number"],input[type="password"]{border:1px solid #ddd;border-radius:10px;padding:8px 10px}
        .btn{border:none;border-radius:10px;padding:8px 12px;background:#111;color:#fff;cursor:pointer}
        .btn-outline{background:#fff;color:#111;border:1px solid #ddd}
        .muted{color:var(--muted)}
        .badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;background:#eee}
        .right{margin-left:auto}

        /* Dezente Hervorhebung je Bestellung in Einzelansicht */
        .sale-group-0 td{ background:#fafcff }
        .sale-group-1 td{ background:#fffdf6 }
        .sale-first td{ border-top:2px solid #e8e8e8 }
        
        /* Total-Zeile am Ende der Tabelle */
        .total-row td{ border-top:2px solid #333; font-weight:700; font-size:16px; padding-top:14px }
    </style>
</head>
<body>
<header>
    <a href="/">← Zur Kasse</a>
    <strong>Admin</strong>
</header>
<div class="wrap">
    <div class="tabs">
        <button class="tab-btn active" data-tab="sales">Übersicht</button>
        <button class="tab-btn" data-tab="purchases">Käufe</button>
        <button class="tab-btn" data-tab="items">Artikel</button>
        <button class="tab-btn" data-tab="users">Benutzer</button>
        <button class="tab-btn" data-tab="payments">Zahlarten</button>
    </div>

    <!-- Übersicht / Sales Tab -->
    <section id="tab-sales" class="card">
        <div style="display:flex; gap:12px; align-items:center">
            <h3 style="margin:0">Verkaufte Mengen pro Artikel</h3>
            <span id="summary-date" class="badge"></span>
            <!-- Neu: Badges direkt neben dem Datum -->
            <span class="badge">Summe: <span id="sum-total">0.00</span> <span id="sum-currency">CHF</span></span>
            <span class="badge">Transaktionen: <span id="sum-count">0</span></span>
            <button class="btn-outline right" onclick="exportTodayCSV()">CSV Tagesbericht</button>
        </div>
        <!-- Entfernt: separater Badge-Block unter der Überschrift -->
        <div style="overflow:auto;margin-top:10px">
            <table id="per-item">
                <thead><tr><th>Artikel</th><th>Menge</th><th>Summe</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>

        <h4 style="margin-top:18px">Letzte 5 Bestellungen</h4>
        <div style="overflow:auto">
            <table id="last-orders-table">
                <thead><tr><th>Zeit</th><th>Artikel</th><th>Menge</th><th>Zahlart</th><th>Benutzer</th><th>Gesamt</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </section>

    <!-- Käufe Tab -->
    <section id="tab-purchases" class="card" style="display:none">
        <div style="display:flex; gap:12px; align-items:center">
            <h3 id="purchases-title" style="margin:0">Alle Käufe (gruppiert)</h3>
            <span class="badge">Total: <span id="purchases-total">0.00</span> <span id="purchases-currency">CHF</span></span>
            <button class="btn-outline right" onclick="exportPurchasesCSV()">CSV Export (gefiltert)</button>
        </div>

        <!-- Filterbereich -->
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:12px;align-items:center">
            <label>Zeitraum:
                <select id="filter-last">
                    <option value="">Alle</option>
                    <!-- letzte 5 Tage mit Daten werden per JS befüllt -->
                </select>
            </label>
            <div id="custom-range" style="display:none;align-items:center;gap:6px">
                <label>Von <input type="date" id="filter-start"></label>
                <label>Bis <input type="date" id="filter-end"></label>
            </div>
            <label>Zahlart:
                <select id="filter-pm"><option value="">Alle</option></select>
            </label>
            <label>Benutzer:
                <select id="filter-user"><option value="">Alle</option></select>
            </label>
            <label style="display:flex;align-items:center;gap:6px">
                <input type="checkbox" id="filter-grouped" checked> Gruppiert anzeigen
            </label>
            <button class="btn" id="filter-clear">Zurücksetzen</button>
        </div>

        <div style="overflow:auto;margin-top:10px">
            <table id="purchases-table">
                <thead><tr id="purchases-head"><th>Zeit</th><th>Artikel</th><th>Zahlart</th><th>Benutzer</th><th>Gesamt</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </section>

    <!-- Items Tab -->
    <section id="tab-items" class="card" style="display:none">
        <div style="display:flex;gap:10px;align-items:center">
            <h3 style="margin:0">Artikel verwalten</h3>
            <button class="btn right" onclick="addItemRow()">Neuen Artikel</button>
        </div>
        <div style="overflow:auto;margin-top:10px">
            <table id="items-table"><thead><tr><th>Sort</th><th>Name</th><th>Preis</th><th>Aktiv</th><th>Aktion</th></tr></thead><tbody></tbody></table>
        </div>
        <div style="margin-top:10px;display:flex;gap:10px;align-items:center">
            <button class="btn" onclick="saveAllItems()">Änderungen speichern</button>
            <span class="muted" id="items-status"></span>
        </div>
    </section>

    <!-- Users Tab -->
    <section id="tab-users" class="card" style="display:none">
        <div style="display:flex;gap:10px;align-items:center">
            <h3 style="margin:0">Benutzer</h3>
            <button class="btn right" onclick="addUserRow()">Neuer Benutzer</button>
        </div>
        <div style="overflow:auto;margin-top:10px">
            <table id="users-table"><thead><tr><th>Username</th><th>PIN (neu/ändern)</th><th>Admin</th><th>Aktiv</th><th>Aktion</th></tr></thead><tbody></tbody></table>
        </div>
        <div style="margin-top:10px;display:flex;gap:10px;align-items:center">
            <button class="btn" onclick="saveAllUsers()">Änderungen speichern</button>
            <span class="muted" id="users-status"></span>
        </div>
    </section>

    <!-- Payments Tab -->
    <section id="tab-payments" class="card" style="display:none">
        <div style="display:flex;gap:10px;align-items:center">
            <h3 style="margin:0">Zahlarten</h3>
            <button class="btn right" onclick="addPMRow()">Neue Zahlart</button>
        </div>
        <div style="overflow:auto;margin-top:10px">
            <table id="pm-table"><thead><tr><th>Sort</th><th>Name</th><th>Aktiv</th><th>Geschützt</th><th>Aktion</th></tr></thead><tbody></tbody></table>
        </div>
        <div style="margin-top:10px;display:flex;gap:10px;align-items:center">
            <button class="btn" onclick="saveAllPM()">Änderungen speichern</button>
            <span class="muted" id="pm-status"></span>
        </div>
    </section>
</div>

<script>
    // Tabs
    document.querySelectorAll('.tab-btn').forEach(btn=>{
        btn.addEventListener('click',()=>{
            document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
            btn.classList.add('active');
            const tab = btn.dataset.tab;
            ['sales','purchases','items','users','payments'].forEach(t=>{
                document.getElementById('tab-'+t).style.display = (t===tab)?'block':'none';
            });
        });
    });

    function exportTodayCSV(){ 
    window.location='/export_today.csv';
}
    
    function exportPurchasesCSV(){ 
        const params = getFilterParams();
        const qs = new URLSearchParams(params).toString();
        window.location='/export_purchases.csv' + (qs ? ('?'+qs) : '');
    }

    // --- Filter Hilfsfunktionen ---
    function formatDayLabel(date){
        return date.toLocaleDateString('de-DE',{weekday:'short', day:'2-digit', month:'2-digit'});
    }

    // Neu: verfügbare Tage (max. 5) vom Server laden
    async function populateLastDays(){
        const sel=document.getElementById('filter-last');
        sel.innerHTML = '<option value="">Alle</option>';
        try{
            const r=await fetch('/api/admin/available_days');
            const d=await r.json();
            const days=(d.ok && d.days)? d.days : [];
            days.forEach((day, idx)=>{
                const val = day.date; // YYYY-MM-DD
                const dt = new Date(val + 'T00:00:00');
                const label = formatDayLabel(dt);
                const opt=document.createElement('option');
                opt.value = val; opt.textContent = label;
                sel.appendChild(opt);
            });
        }catch(e){ /* still show default options */ }
        const cust=document.createElement('option'); cust.value='custom'; cust.textContent='Benutzerdefiniert...'; sel.appendChild(cust);
        sel.addEventListener('change', ()=>{
            document.getElementById('custom-range').style.display = sel.value==='custom' ? 'flex' : 'none';
            loadPurchases();
        });
    }

    async function populatePMandUsers(){
        // Zahlarten
        const pmSel=document.getElementById('filter-pm'); pmSel.innerHTML='<option value="">Alle</option>';
        const rpm=await fetch('/api/payment_methods'); const dpm=await rpm.json(); (dpm.methods||[]).forEach(m=>{ const o=document.createElement('option'); o.value=m.id; o.textContent=m.name; pmSel.appendChild(o); });
        // Users
        const uSel=document.getElementById('filter-user'); uSel.innerHTML='<option value="">Alle</option>';
        const ru=await fetch('/api/users'); const du=await ru.json(); (du.users||[]).forEach(u=>{ const o=document.createElement('option'); o.value=u.id; o.textContent=u.username; uSel.appendChild(o); });
    }

    function getFilterParams(){
        const sel=document.getElementById('filter-last').value;
        const params = {};
        if(sel && sel!=='custom'){
            params.start = sel;
            params.end = sel;
        } else if(sel==='custom'){
            const s=document.getElementById('filter-start').value;
            const e=document.getElementById('filter-end').value;
            if(s) params.start = s;
            if(e) params.end = e;
        }
        const pm = document.getElementById('filter-pm').value; if(pm) params.payment_method_id = pm;
        const user = document.getElementById('filter-user').value; if(user) params.user_id = user;
        params.group = document.getElementById('filter-grouped').checked ? '1' : '0';
        return params;
    }

    // ---- Load Sales ----
    async function loadSales(){
        const r = await fetch('/api/admin/summary');
        const data = await r.json();
        if(!data.ok) return;

        // Datum/Badges und Summen
        document.getElementById('summary-date').textContent = data.date_label;
        document.getElementById('sum-total').textContent = data.total.toFixed(2);
        document.getElementById('sum-currency').textContent = data.currency;
        document.getElementById('sum-count').textContent = data.count;

        // Per-Artikel
        const pi = document.querySelector('#per-item tbody'); pi.innerHTML='';
        (data.per_item||[]).forEach(r=>{
            const tr=document.createElement('tr');
            tr.innerHTML = `<td>${r.item_name}</td><td>${r.qty}</td><td>${(+r.total).toFixed(2)} ${data.currency}</td>`;
            pi.appendChild(tr);
        });

        // Letzte 5 Bestellungen (Einzelposten, farblich gruppiert)
        const tb = document.querySelector('#last-orders-table tbody'); tb.innerHTML='';
        let lastSaleId = null, groupIdx = 1;
        (data.last5_rows||[]).forEach(rw=>{
            const tr=document.createElement('tr');
            let firstOfSale = false;
            if(rw.sale_id !== lastSaleId){
                groupIdx = 1 - groupIdx;
                lastSaleId = rw.sale_id;
                firstOfSale = true;
            }
            tr.classList.add(`sale-group-${groupIdx}`);
            if(firstOfSale) tr.classList.add('sale-first');
            tr.innerHTML = `<td>${rw.ts}</td><td>${rw.item_name}</td><td>${rw.qty}</td><td>${rw.payment_method||''}</td><td>${rw.user||''}</td><td>${(+rw.total).toFixed(2)} ${data.currency}</td>`;
            tb.appendChild(tr);
        });
    }

    // ---- Load Purchases (neu mit Total) ----
 // ---- Load Purchases (neu mit Total + Storno) ----
    async function loadPurchases(){
        const params = getFilterParams();
        const qs = new URLSearchParams(params).toString();
        const r = await fetch('/api/admin/purchases' + (qs?('?'+qs):''));
        const data = await r.json();
        if(!data.ok) return;

        const titleEl = document.getElementById('purchases-title');
        if(titleEl) titleEl.textContent = data.grouped ? 'Alle Käufe (gruppiert)' : 'Alle Käufe (Einzelposten)';

        const head = document.getElementById('purchases-head');
        if(data.grouped){
            head.innerHTML = '<th>Zeit</th><th>Artikel</th><th>Zahlart</th><th>Benutzer</th><th>Gesamt</th><th>Aktion</th>';
        } else {
            head.innerHTML = '<th>Zeit</th><th>Artikel</th><th>Menge</th><th>Zahlart</th><th>Benutzer</th><th>Gesamt</th><th>Aktion</th>';
        }

        const tb = document.querySelector('#purchases-table tbody'); tb.innerHTML='';
        let grandTotal = 0;

        if(data.grouped){
            (data.purchases||[]).forEach(p=>{
                const tr=document.createElement('tr');
                const itemsStr = (p.lines||[]).map(l=>`${l.qty}x ${l.item_name}`).join(', ');
                tr.innerHTML = `<td>${p.ts}</td><td>${itemsStr}</td><td>${p.payment_method||''}</td><td>${p.user||''}</td><td>${p.total.toFixed(2)} ${data.currency}</td><td><button class="btn-outline" style="color:#b00020;border-color:#b00020" onclick="deleteSale(${p.id})">✕ Storno</button></td>`;
                tb.appendChild(tr);
                grandTotal += p.total;
            });
        } else {
            // Einzelposten: farblich pro Bestellung gruppieren
            let lastSaleId = null, groupIdx = 1;
            (data.rows||[]).forEach((rw, i)=>{
                const tr=document.createElement('tr');
                let firstOfSale = false;
                if(rw.sale_id !== lastSaleId){
                    groupIdx = 1 - groupIdx;
                    lastSaleId = rw.sale_id;
                    firstOfSale = true;
                }
                tr.classList.add(`sale-group-${groupIdx}`);
                if(firstOfSale) tr.classList.add('sale-first');
                // Storno-Button nur in erster Zeile einer Bestellung
                const actionBtn = firstOfSale ? `<button class="btn-outline" style="color:#b00020;border-color:#b00020" onclick="deleteSale(${rw.sale_id})">✕ Storno</button>` : '';
                tr.innerHTML = `<td>${rw.ts}</td><td>${rw.item_name}</td><td>${rw.qty}</td><td>${rw.payment_method||''}</td><td>${rw.user||''}</td><td>${rw.total.toFixed(2)} ${data.currency}</td><td>${actionBtn}</td>`;
                tb.appendChild(tr);
                grandTotal += rw.total;
            });
        }

        // Badge oben aktualisieren
        document.getElementById('purchases-total').textContent = grandTotal.toFixed(2);
        document.getElementById('purchases-currency').textContent = data.currency;

        // Total-Zeile am Ende der Tabelle hinzufügen
        const totalRow = document.createElement('tr');
        totalRow.className = 'total-row';
        const colspan = data.grouped ? 5 : 6; // +1 wegen Aktions-Spalte
        totalRow.innerHTML = `<td colspan="${colspan}" style="text-align:right">Gesamt:</td><td><strong>${grandTotal.toFixed(2)} ${data.currency}</strong></td>`;
        tb.appendChild(totalRow);
    }

    // Neue Funktion: Bestellung stornieren
    async function deleteSale(saleId){
        if(!confirm('Bestellung wirklich stornieren? Diese Aktion kann nicht rückgängig gemacht werden.')) return;
        
        const r = await fetch(`/api/admin/delete_sale/${saleId}`, {method:'DELETE'});
        const d = await r.json();
        
        if(d.ok){
            notify('Bestellung storniert.');
            loadPurchases(); // Tabelle neu laden
            loadSales(); // Übersicht auch aktualisieren
        } else {
            alert('Fehler beim Stornieren: ' + (d.msg || 'Unbekannt'));
        }
    }

    // Notify Funktion hinzufügen (falls noch nicht vorhanden)
    function notify(msg){
        alert(msg); // Simple Version - kannst du später mit Toast ersetzen
    }

    // ---- Items CRUD ----
    let items=[];
    function itemRow(it){
        const tr=document.createElement('tr'); tr.dataset.id=it.id||'';
        tr.innerHTML = `<td><input type="number" value="${it.sort??0}" style="width:80px"></td>
      <td><input type="text" value="${it.name||''}"></td>
      <td><input type="number" step="0.05" min="0" value="${(it.price??0).toFixed(2)}" style="width:120px"></td>
      <td><input type="checkbox" ${it.active?'checked':''}></td>
      <td><button class="btn-outline" onclick="dupItem(this)">Duplizieren</button>
          <button class="btn-outline" onclick="delRow(this)">Löschen</button></td>`;
        return tr;
    }
    function renderItems(){ const tb=document.querySelector('#items-table tbody'); tb.innerHTML=''; items.sort((a,b)=>(a.sort||0)-(b.sort||0)); items.forEach(i=>tb.appendChild(itemRow(i))); }
    function addItemRow(){ document.querySelector('#items-table tbody').appendChild(itemRow({name:'Neuer Artikel',price:0,active:true,sort:(items.length?Math.max(...items.map(i=>i.sort||0))+1:0)})); }
    function dupItem(btn){ const tr=btn.closest('tr'); const [s,n,p,a]=tr.querySelectorAll('input'); const clone=itemRow({sort:parseInt(s.value||0)+1, name:n.value+" (Kopie)", price:parseFloat(p.value||0), active:a.checked}); tr.after(clone); }

    async function loadItems(){ const r=await fetch('/api/items'); const data=await r.json(); items=data.items||[]; renderItems(); }
    async function saveAllItems(){ const rows=[...document.querySelectorAll('#items-table tbody tr')]; const payload=rows.map(tr=>{const [s,n,p,a]=tr.querySelectorAll('input'); return {id:tr.dataset.id||null, delete:tr.dataset.delete==='1', sort:parseInt(s.value||0), name:n.value.trim(), price:parseFloat(p.value||0), active:a.checked};}); const r=await fetch('/api/items/bulk',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({items:payload})}); const d=await r.json(); const el=document.getElementById('items-status'); if(d.ok){ el.textContent='Gespeichert.'; await loadItems(); setTimeout(()=>el.textContent='',1500);} else { el.textContent='Fehler'; } }

    function delRow(btn){ const tr=btn.closest('tr'); if(tr.dataset.id){ tr.dataset.delete='1'; tr.style.opacity=.5; } else tr.remove(); }

    // ---- Users CRUD ----
    let users=[];
    function userRow(u){
        const tr=document.createElement('tr'); tr.dataset.id=u.id||'';
        tr.innerHTML = `<td><input type="text" value="${u.username||''}"></td>
      <td><input type="password" placeholder="neu setzen…"></td>
      <td><input type="checkbox" ${u.is_admin?'checked':''}></td>
      <td><input type="checkbox" ${u.active?'checked':''}></td>
      <td><button class="btn-outline" onclick="delRow(this)">Löschen</button></td>`;
        return tr;
    }
    function renderUsers(){ const tb=document.querySelector('#users-table tbody'); tb.innerHTML=''; users.forEach(u=>tb.appendChild(userRow(u))); }
    function addUserRow(){ document.querySelector('#users-table tbody').appendChild(userRow({username:'', is_admin:false, active:true})); }
    async function loadUsers(){ const r=await fetch('/api/users'); const d=await r.json(); users=d.users||[]; renderUsers(); }
    async function saveAllUsers(){ const rows=[...document.querySelectorAll('#users-table tbody tr')]; const payload=rows.map(tr=>{const [name,pin,admin,active]=tr.querySelectorAll('input'); return {id:tr.dataset.id||null, delete:tr.dataset.delete==='1', username:name.value.trim(), pin:pin.value.trim(), is_admin:admin.checked, active:active.checked};}); const r=await fetch('/api/users/bulk',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({users:payload})}); const d=await r.json(); const el=document.getElementById('users-status'); if(d.ok){ el.textContent='Gespeichert.'; await loadUsers(); setTimeout(()=>el.textContent='',1500);} else { el.textContent='Fehler'; }
    }

    // ---- Payment Methods CRUD ----
    let methods=[];
    function pmRow(m){
        const tr=document.createElement('tr'); tr.dataset.id=m.id||''; if(m.protected) tr.dataset.protected='1';
        tr.innerHTML = `<td><input type="number" value="${m.sort??0}" style="width:80px"></td>
      <td><input type="text" value="${m.name||''}"></td>
      <td><input type="checkbox" ${m.active?'checked':''}></td>
      <td>${m.protected? 'Ja':'Nein'}</td>
      <td>${m.protected? '—': '<button class="btn-outline" onclick="delRow(this)">Löschen</button>'}</td>`;
        return tr;
    }
    function renderPM(){ const tb=document.querySelector('#pm-table tbody'); tb.innerHTML=''; methods.sort((a,b)=>(a.sort||0)-(b.sort||0)); methods.forEach(m=>tb.appendChild(pmRow(m))); }
    function addPMRow(){ document.querySelector('#pm-table tbody').appendChild(pmRow({name:'Neue Zahlart', active:true, sort:(methods.length?Math.max(...methods.map(i=>i.sort||0))+1:0), protected:false})); }
    async function loadPM(){ const r=await fetch('/api/payment_methods'); const d=await r.json(); methods=d.methods||[]; renderPM(); }
    async function saveAllPM(){ const rows=[...document.querySelectorAll('#pm-table tbody tr')]; const payload=rows.map(tr=>{const [s,n,a]=tr.querySelectorAll('input'); return {id:tr.dataset.id||null, delete:tr.dataset.delete==='1', sort:parseInt(s.value||0), name:n.value.trim(), active:a.checked, protected: tr.dataset.protected==='1'};}); const r=await fetch('/api/payment_methods/bulk',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({methods:payload})}); const d=await r.json(); const el=document.getElementById('pm-status'); if(d.ok){ el.textContent='Gespeichert.'; await loadPM(); setTimeout(()=>el.textContent='',1500);} else { el.textContent='Fehler'; }
    }

    // Filter-Events
    document.getElementById('filter-clear').addEventListener('click', ()=>{
        document.getElementById('filter-last').value=''; document.getElementById('custom-range').style.display='none';
        document.getElementById('filter-start').value=''; document.getElementById('filter-end').value='';
        document.getElementById('filter-pm').value=''; document.getElementById('filter-user').value=''; document.getElementById('filter-grouped').checked=true;
        loadPurchases();
    });
    document.getElementById('filter-grouped').addEventListener('change', ()=>loadPurchases());
    // neu: alle Filter triggern automatisch
    document.getElementById('filter-pm').addEventListener('change', ()=>loadPurchases());
    document.getElementById('filter-user').addEventListener('change', ()=>loadPurchases());
    document.getElementById('filter-start').addEventListener('change', ()=>loadPurchases());
    document.getElementById('filter-end').addEventListener('change', ()=>loadPurchases());

    // Init
    populateLastDays();
    populatePMandUsers();
    loadSales(); loadPurchases(); loadItems(); loadUsers(); loadPM();
</script>
</body>
</html>