<!doctype html>
<html lang="de">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <title>POS – Kasse</title>
    <style>
        :root{ --bg:#f6f8fa; --panel:#fff; --ink:#111; --muted:#6b7280; --ring:#111; }
        *{ box-sizing:border-box }
        body{ margin:0; font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:var(--bg); color:var(--ink) }
        header{ background:#111; color:#fff; padding:12px 16px; display:flex; align-items:center; gap:8px }
        header .right{ margin-left:auto; display:flex; gap:8px }
        header a{ color:#fff; text-decoration:none; background:#2a2a2a; padding:6px 10px; border-radius:10px }

        .wrap{ max-width:1100px; margin:0 auto; padding:16px }

        .grid{ display:grid; grid-template-columns:2fr 1fr; gap:12px }
        @media (max-width: 900px){ .grid{ grid-template-columns:1fr } }

        /* Produktkarten */
        .items{ display:grid; grid-template-columns:repeat(auto-fill, minmax(180px,1fr)); gap:12px }
        .card{ background:var(--panel); border-radius:16px; padding:14px; box-shadow:0 2px 8px rgba(0,0,0,.06); position:relative }
        .price-badge{ position:absolute; top:-8px; right:-8px; background:#111; color:#fff; font-weight:700; border-radius:999px; padding:6px 10px; font-size:12px }
        .item-title{ font-weight:800; margin-bottom:8px }
        .qty-row{ display:flex; align-items:center; gap:8px }
        .qty-btn{ width:36px; height:36px; border-radius:10px; border:none; background:#f1f5f9; font-size:18px; cursor:pointer }
        .qty{ min-width:28px; text-align:center }

        /* Kasse */
        .panel{ background:#fff; border-radius:16px; padding:14px; box-shadow:0 2px 8px rgba(0,0,0,.06) }
        .panel h3{ margin:0 0 8px }
        .cart{ display:grid; gap:6px; margin-bottom:10px }
        .row{ display:flex; align-items:center; gap:8px; justify-content:space-between }
        .pill{ background:#f1f5f9; border-radius:999px; padding:4px 8px; font-size:12px }

        .pay-grid{ display:grid; grid-template-columns:repeat(auto-fit, minmax(90px, 1fr)); gap:8px; margin-top:8px }
        .pay{ border:2px solid #e5e7eb; border-radius:12px; padding:10px; cursor:pointer; text-align:center }
        .pay.active{ border-color:#111 }

        .money-grid{ display:grid; grid-template-columns:repeat(4, 1fr); gap:8px; align-items:end }
        .money-grid label{ font-size:12px; color:var(--muted) }
        .money-grid input{ width:100%; padding:10px; border:1px solid #e5e7eb; border-radius:10px; font-size:16px; text-align:center }
        .money-btn{ padding:10px; border:2px solid #e5e7eb; background:#fff; border-radius:10px; cursor:pointer }

        .total{ display:flex; justify-content:space-between; font-weight:800; margin-top:8px }
        .btn{ width:100%; padding:12px 16px; border:none; background:#111; color:#fff; border-radius:12px; margin-top:10px; cursor:pointer; font-weight:700 }
    </style>
</head>
<body>
<header>
    <div>POS – Kasse</div>
    <div class="right">
        {% if user.is_admin %}<a href="/admin">Admin</a>{% endif %}
        <a href="/logout">Logout</a>
    </div>
</header>

<div class="wrap">
    <div class="grid">
        <div>
            <div class="items">
                {% for it in items %}
                <div class="card" data-id="{{ it.id }}" data-price="{{ '%.2f'|format(it.price) }}">
                    <div class="price-badge">{{ '%.2f'|format(it.price) }} CHF</div>
                    <div class="item-title">{{ it.name }}</div>
                    <div class="qty-row">
                        <button class="qty-btn" data-act="-">–</button>
                        <div class="qty" data-qty>0</div>
                        <button class="qty-btn" data-act="+">+</button>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <div>
            <div class="panel">
                <h3>Warenkorb</h3>
                <div id="cart" class="cart"></div>
                <div class="total"><div>Summe</div><div id="sum">0.00 CHF</div></div>

                <h3 style="margin-top:16px">Zahlart</h3>
                <div id="pays" class="pay-grid"></div>

                <div style="margin-top:10px">
                    <div class="money-grid">
                        <label>Betrag</label>
                        <label>Rückgeld</label>
                        <label class="hide-on-digital"></label>
                        <label class="hide-on-digital"></label>

                        <input id="received" type="text" inputmode="none" value="0" />
                        <input id="change" type="text" readonly value="0.00 CHF" />
                        <button class="money-btn hide-on-digital" data-add="10">+10</button>
                        <button class="money-btn hide-on-digital" data-add="50">+50</button>
                        <button class="money-btn hide-on-digital" data-add="100">+100</button>
                        <button class="money-btn hide-on-digital" data-clear>Leeren</button>
                    </div>
                    <button id="checkout" class="btn">Kassieren</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const CURRENCY = '{{ currency or "CHF" }}';
    const fmt = n => (Number(n)||0).toFixed(2) + ' ' + CURRENCY;

    // Produkte
    const items = Array.from(document.querySelectorAll('.card[data-id]'));
    const cartEl = document.getElementById('cart');
    const sumEl = document.getElementById('sum');
    const paysEl = document.getElementById('pays');
    const receivedEl = document.getElementById('received');
    const changeEl = document.getElementById('change');

    const payMethods = {{ pay_methods|tojson }};
    let cart = new Map();
    let activePay = payMethods[0]?.name || 'Bar';

    function renderPays(){
        paysEl.innerHTML='';
        payMethods.forEach(pm=>{
            const b=document.createElement('button'); b.className='pay' + (pm.name===activePay?' active':''); b.textContent=pm.name; b.onclick=()=>{ activePay=pm.name; onPaymentChange();};
            paysEl.appendChild(b);
        });
    }

    function onPaymentChange(){
        const isCash = activePay.toLowerCase() === 'bar';
        document.querySelectorAll('.hide-on-digital').forEach(el=> el.style.display = isCash ? '' : 'none');
        if(!isCash){ receivedEl.value = sumEl.textContent.replace(' '+CURRENCY,''); updateChange(); }
        else { if(!receivedEl.value || receivedEl.value==='0') { receivedEl.value = '0'; updateChange(); } }
    }

    function renderCart(){
        cartEl.innerHTML='';
        let total=0;
        for(const [id, ln] of cart){
            const row=document.createElement('div'); row.className='row';
            row.innerHTML = `<div>${ln.name}</div><div class="pill">${ln.qty}× ${fmt(ln.price)}</div>`;
            cartEl.appendChild(row);
            total += ln.qty * ln.price;
        }
        sumEl.textContent = fmt(total);
        updateChange();
    }

    function updateChange(){
        const sum = parseFloat(sumEl.textContent);
        const rec = parseFloat(receivedEl.value.replace(',','.')) || 0;
        const diff = rec - sum;
        changeEl.value = (diff>=0? 'Rückgeld: ' : 'Fehlbetrag: ') + fmt(Math.abs(diff));
    }

    items.forEach(card=>{
        const id=parseInt(card.dataset.id);
        const name=card.querySelector('.item-title').textContent;
        const price=parseFloat(card.dataset.price);
        const qtyEl=card.querySelector('[data-qty]');
        card.addEventListener('click', (ev)=>{
            const act = ev.target.getAttribute('data-act');
            if(act==='+'||act==='-'){
                const cur = parseInt(qtyEl.textContent)||0;
                const next = Math.max(0, cur + (act==='+'?1:-1));
                qtyEl.textContent = next;
                if(next>0) cart.set(id, {id,name,price,qty:next}); else cart.delete(id);
                renderCart();
            }
        });
    });

    receivedEl.addEventListener('click', ()=>{
        // eigenes Numpad anzeigen (analog Login) – in deiner Version bereits vorhanden
    });
    document.querySelectorAll('[data-add]').forEach(b=> b.onclick=()=>{ receivedEl.value = String((parseFloat(receivedEl.value||'0')||0) + parseFloat(b.dataset.add)); updateChange(); });
    document.querySelector('[data-clear]').onclick=()=>{ receivedEl.value='0'; updateChange(); };

    document.getElementById('checkout').onclick=async()=>{
        const lines = Array.from(cart.values()).map(x=>({item_id:x.id, qty:x.qty}));
        if(lines.length===0){ alert('Warenkorb ist leer'); return; }
        const res = await fetch('/sale',{method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({payment_method_id: payMethods.find(p=>p.name===activePay).id, lines})});
        const d = await res.json();
        if(d.ok){ cart.clear(); renderCart(); receivedEl.value='0'; updateChange(); notify('Verkauf gespeichert'); }
        else { alert(d.msg||'Fehler'); }
    };

    function notify(text){
        const t=document.createElement('div'); t.textContent=text; t.style.cssText='position:fixed;left:50%;top:16px;transform:translateX(-50%);background:#111;color:#fff;padding:10px 12px;border-radius:10px;box-shadow:0 4px 16px rgba(0,0,0,.2);z-index:9999';
        document.body.appendChild(t);
        setTimeout(()=> t.classList.remove('show'), 1400); }
    function init(){ renderPays(); onPaymentChange(); updateSum(); }
    function updateSum(){ updateChange(); }
    init();
</script>
</body>
</html>
