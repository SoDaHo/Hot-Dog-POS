<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="theme-color" content="#111111" /><link rel="apple-touch-icon" href="/icons/icon-192.png" />
    <title>Hot-Dog Kasse</title>
    <style>
        *{box-sizing:border-box}
        body { font-family: system-ui, sans-serif; background:#f6f6f6; margin:0; padding-top: env(safe-area-inset-top); padding-bottom: env(safe-area-inset-bottom); }
        @supports (padding: constant(safe-area-inset-top)) {
            body { padding-top: constant(safe-area-inset-top); padding-bottom: constant(safe-area-inset-bottom); }
        }
        header { background:#111; color:#fff; padding:10px 16px; display:flex; align-items:center; gap:8px }
        header .right{ margin-left:auto; display:flex; align-items:center; gap:8px }
        header a{ color:#fff; text-decoration:none; background:#2a2a2a; padding:6px 10px; border-radius:10px }

        .wrap{ max-width:980px; margin:0 auto; padding:16px }
        .grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap:12px; }

        .card{ background:#fff; border-radius:16px; padding:12px; position:relative; box-shadow:0 2px 6px rgba(0,0,0,.07); }
        .item{ min-height:96px; display:flex; flex-direction:column; gap:8px; }
        .item .row{ display:flex; align-items:center; gap:8px }
        .item h3 { margin:0; font-size:18px; flex:1; }
        .price { position:absolute; top:8px; right:8px; background:#f1f1f1; color:#333; border-radius:10px; padding:4px 8px; font-size:12px; font-weight:700; box-shadow:0 1px 3px rgba(0,0,0,.08) }
        .qty { display:flex; gap:8px; align-items:center; justify-content:center; margin:0 auto }
        .qty button { border:none; border-radius:12px; padding:10px 14px; background:#f2f2f2; cursor:pointer; font-size:18px }
        .qty .val { min-width:34px; text-align:center; font-weight:800 }
        .badge { background:#111; color:#fff; border-radius:999px; min-width:22px; height:22px; display:none; align-items:center; justify-content:center; font-size:12px; font-weight:800; position:absolute; top:-6px; right:-6px; box-shadow:0 2px 6px rgba(0,0,0,.2); padding:0 6px }
        .add-quick{ display:none; border:none; border-radius:12px; padding:6px 10px; background:#111; color:#fff; cursor:pointer; position:absolute; right:8px; bottom:8px }

        .line { display:flex; justify-content:space-between; align-items:center; gap:12px; padding:12px 14px; background:#fff; border-radius:12px; margin-top:12px; box-shadow:0 2px 8px rgba(0,0,0,.06) }
        .total { font-size:28px; font-weight:800 }
        .small { font-size:12px; color:#666 }
        .btn { display:inline-block; border:none; border-radius:12px; padding:12px 16px; background:#111; color:#fff; cursor:pointer }
        .btn:disabled { background:#999; cursor:not-allowed; opacity:0.6 }

        /* Zahlungsbereich */
        .pay{ display:flex; flex-direction:column; gap:10px }
        .pm-grid{ display:grid; gap:12px; align-items:stretch }
        .pm-grid button{ padding:14px; border-radius:12px; border:2px solid #ddd; background:#fff; cursor:pointer; height:56px; display:flex; align-items:center; justify-content:center; font-weight:600; width:100% }
        .pm-grid button.active{ border-color:#111; box-shadow:0 2px 8px rgba(0,0,0,.1) }

        /* Toast */
        #toast { position:fixed; bottom:24px; left:50%; transform:translateX(-50%); background:#111; color:#fff; padding:10px 18px; border-radius:999px; opacity:0; transition:opacity .25s ease; z-index:1000 }
        #toast.show { opacity:1 }

        /* Spinner */
        .spinner { display:inline-block; width:16px; height:16px; border:2px solid rgba(255,255,255,.3); border-top-color:#fff; border-radius:50%; animation:spin .6s linear infinite; margin-right:8px }
        @keyframes spin { to { transform:rotate(360deg) } }

        /* Mobile kompakt */
        @media (max-width: 600px){
            .grid{ grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); }
            .item.compact .price{ display:none }
            .item.compact .qty{ display:none }
            .item.compact .badge{ display:inline-flex }
            .item.compact .add-quick{ display:block }
            .item.expanded .qty{ display:flex }
            .item.expanded .price{ display:block; font-size:13px; color:#777 }
            .item.expanded .add-quick{ display:none }

            .pm-grid{ grid-template-columns: repeat(3, 1fr) !important; }
        }
        .item.compact .price{ display:none }
        .item.compact .qty{ display:none }
        .item.compact .badge{ display:inline-flex }
        .item.compact .add-quick{ display:block }
        .item.expanded .qty{ display:flex }
        .item.expanded .price{ display:block; font-size:13px; color:#777 }
        .item.expanded .add-quick{ display:none }

        .pm-grid{ grid-template-columns: repeat(3, 1fr) !important; }
        }

        /* Erzwinge 3 Zahlarten pro Zeile (auch Desktop) */
        .pm-grid{ grid-template-columns: repeat(3, 1fr); }

        /* Gleichmäßige Abstände zwischen Summe und Zahlungsbereich */
        .line{ margin-bottom:12px; }
        .card.pay{ margin-top:0; }
        .small{ display:block; margin-bottom:6px; }
    </style>
</head>
<body>
<header>
    <div>Hot-Dog Kasse</div>
    <div class="right">
        <div>eingeloggt: <strong>{{ user.username }}</strong></div>
        {% if user.is_admin %}<a href="/admin">Admin</a>{% endif %}
        <a href="/logout">Logout</a>
    </div>
</header>

<div class="wrap">
    <div class="grid" id="items"></div>

    <div class="line">
        <div>
            <div class="small">Warenkorb-Summe</div>
            <div class="total"><span id="sum">0.00</span> {{currency}}</div>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
            <button id="clear" class="btn" style="background:#444">Leeren</button>
        </div>
    </div>

    <div class="card pay">
        <div>
            <div class="small">Zahlart</div>
            <div class="pm-grid" id="pm"></div>
        </div>

        <div>
            <button id="pay" class="btn" style="font-size:20px;width:100%">Kassieren</button>
        </div>
    </div>
</div>

<div id="toast"></div>

<script>
    // PWA rückgängig machen: vorhandene Service Worker entfernen & Cache leeren
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.getRegistrations().then((regs)=>regs.forEach(r=>r.unregister()));
    }
    if (window.caches && caches.keys) {
        caches.keys().then(keys => keys.forEach(k => caches.delete(k)));
    }

    // ==== Kassen-App Logik (vereinfacht ohne Cash-Flow) ====
    const CURRENCY = "{{currency}}";
    const items = {{ items | tojson }};             // [{id,name,price}]
    const payMethods = {{ pay_methods | tojson | default('[]') }}; // [{id,name,protected}]

    const cart = {}; let activePM = payMethods.length ? payMethods[0].id : null;
    const isMobile = window.matchMedia('(max-width: 600px)');

    function notify(msg){ let t=document.getElementById('toast'); if(!t){ t=document.createElement('div'); t.id='toast'; document.body.appendChild(t);} t.textContent=msg; t.classList.add('show'); setTimeout(()=> t.classList.remove('show'), 1400); }

    // Items
    const expanded = new Map();
    function addItemQty(id, delta){ cart[id]=Math.max(0,(cart[id]||0)+delta); updateSum(); updateItemQtyBadges(id); }
    function updateItemQtyBadges(id){ const q=cart[id]||0; const b=document.querySelector(`[data-badge="${id}"]`); if(b){ b.style.display = q>0 ? 'inline-flex' : 'none'; b.textContent=String(q); } const v=document.querySelector(`[data-qty="${id}"]`); if(v){ v.textContent=q; } }
    function renderItems(){ const el=document.getElementById('items'); if(!el) return; el.innerHTML=''; (items||[]).forEach(it=>{ const card=document.createElement('div'); card.className='card item'; card.dataset.id=it.id; card.innerHTML=
        `<div class='row'><h3>${it.name}</h3><div class='price'>${(+it.price).toFixed(2)} ${CURRENCY}</div></div>
     <div class='qty'><button onclick="addItemQty(${it.id},-1)">−</button><div class='val' data-qty='${it.id}'>${cart[it.id]||0}</div><button onclick="addItemQty(${it.id},1)">+</button></div>
     <span class='badge' data-badge='${it.id}'>${cart[it.id]||0}</span>
     <button class='add-quick' onclick="addItemQty(${it.id},1)">+1</button>`;
        if(isMobile.matches){ card.classList.add('compact'); card.addEventListener('click', (ev)=>{ const insideControls=ev.target.closest('.qty')||ev.target.classList.contains('add-quick')||ev.target.hasAttribute('data-badge'); if(insideControls) return; const id=it.id; const isExp=expanded.get(id)===true; expanded.set(id,!isExp); card.classList.toggle('expanded', !isExp); card.classList.toggle('compact', isExp); }); let sx=null; card.addEventListener('touchstart',e=>{ sx=e.changedTouches[0].screenX;}); card.addEventListener('touchend',e=>{ if(sx==null) return; const dx=e.changedTouches[0].screenX - sx; if(Math.abs(dx)>40){ addItemQty(it.id, dx>0? +1 : -1); } sx=null;}); }
        el.appendChild(card); updateItemQtyBadges(it.id); }); }
    document.addEventListener('click',(e)=>{ const b=e.target && e.target.closest ? e.target.closest('[data-badge]') : null; if(!b) return; const id=parseInt(b.getAttribute('data-badge')); cart[id]=0; updateSum(); updateItemQtyBadges(id); e.stopPropagation(); });

    // Payment methods
    function renderPM(){ const el=document.getElementById('pm'); if(!el) return; el.innerHTML=''; (payMethods||[]).forEach(pm=>{ const b=document.createElement('button'); b.textContent=pm.name; if(pm.id===activePM) b.classList.add('active'); b.onclick=()=>{ activePM=pm.id; renderPM(); }; el.appendChild(b); }); }

    // Sum
    function cartTotal(){ let s=0; for(const it of (items||[])){ if(cart[it.id]) s+=cart[it.id]*it.price; } return s; }
    function updateSum(){ const sumEl=document.getElementById('sum'); const s=cartTotal(); if(sumEl) sumEl.textContent=s.toFixed(2); }

    // Controls
    const clearBtn=document.getElementById('clear'); if(clearBtn) clearBtn.onclick=()=>{ for(const k in cart) delete cart[k]; renderItems(); updateSum(); notify('Warenkorb geleert'); };
    
    const payBtn=document.getElementById('pay'); 
    if(payBtn) payBtn.onclick=async()=>{ 
        const lines=Object.entries(cart).filter(([id,q])=>q>0).map(([id,q])=>({item_id:parseInt(id),qty:q})); 
        if(!lines.length){ notify('Bitte Artikel wählen.'); return;} 
        if(!activePM){ notify('Bitte Zahlart wählen.'); return;} 
        
        // Button disablen + Ladeindikator
        payBtn.disabled = true;
        const originalText = payBtn.innerHTML;
        payBtn.innerHTML = '<span class="spinner"></span>Wird gespeichert...';
        
        try {
            const pm=payMethods.find(p=>p.id===activePM);
            const res=await fetch('/sale',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({lines,payment_method_id:activePM})}); 
            const data=await res.json(); 
            if(data.ok){ 
                notify(`Verkauf gespeichert – Zahlart: ${pm?pm.name:'Unbekannt'}`); 
                for(const k in cart) delete cart[k]; 
                renderItems(); 
                updateSum(); 
            } else { 
                notify('Fehler: '+(data.msg||'Unbekannt')); 
            }
        } finally {
            // Button wieder enablen
            payBtn.disabled = false;
            payBtn.innerHTML = originalText;
        }
    };

    // init
    renderItems(); renderPM(); updateSum();
</script>
</body>
</html>